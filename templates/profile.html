{% extends "base.html" %}

{% block title %}Profilom - Mondom a Tutit!{% endblock %}

{% block content %}
    <h1>Profilom</h1>
    <p><strong>E-mail címed:</strong> {{ user.email }}</p>
    <p><strong>Előfizetés állapota:</strong> {% if is_subscribed %}Aktív ✅{% else %}Inaktív ❌{% endif %}</p>

    <hr style="margin: 30px 0;">

    <h2>Előfizetés Kezelése</h2>
    <p>Itt tudod kezelni a bankkártyaadataidat vagy lemondani a megújuló előfizetésedet a Stripe biztonságos felületén.</p>
    <form action="/create-portal-session" method="POST">
        <button type="submit" class="button">Ugrás az Ügyfélportálra</button>
    </form>

    <hr style="margin: 30px 0;">

    <h2>Telegram Összekötés</h2>
    {% if user.chat_id %}
        <div class="alert" style="background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb;">
            <strong>A Telegram fiókod már össze van kötve!</strong><br>
            Mostantól automatikus értesítéseket kapsz a friss tippekről.
        </div>
    {% else %}
        <p>Szeretnél azonnali értesítést kapni a Telegramon? Kösd össze a fiókodat!</p>
        <form action="/generate-telegram-link" method="POST" id="telegram-form">
            <button type="submit" class="button">Összekötés Indítása</button>
        </form>
        <div id="telegram-link-container" style="display:none; margin-top: 15px;">
             <div class="alert" style="background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb;">
                <strong>Sikeresen legeneráltuk a linked!</strong><br>
                Kattints rá, hogy a Telegramban megerősítsd az összekötést, majd frissítsd ezt az oldalt.
            </div>
        </div>
    {% endif %}

<script>
// Ez a script kezeli a Telegram link generálását anélkül, hogy új oldalra vinne
const form = document.getElementById('telegram-form');
if (form) {
    form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const response = await fetch('/generate-telegram-link', {
            method: 'POST'
        });
        const linkContainer = document.getElementById('telegram-link-container');
        if (response.ok) {
            const content = await response.text();
            linkContainer.innerHTML = content;
            linkContainer.style.display = 'block';
            form.style.display = 'none';
        } else {
            linkContainer.innerHTML = '<p style="color: red;">Hiba történt a link generálása közben.</p>';
            linkContainer.style.display = 'block';
        }
    });
}
</script>

{% endblock %}
