{% extends "base.html" %}

{% block title %}Profilom - Mondom a Tutit!{% endblock %}

{% block content %}
    <h1>Profilom</h1>
    <p><strong>E-mail címed:</strong> {{ user.email }}</p>
    <p><strong>Előfizetés állapota:</strong> {% if is_subscribed %}Aktív ✅{% else %}Inaktív ❌{% endif %}</p>

    <hr>

    <h2>Előfizetés Kezelése</h2>
    <p>Itt tudod kezelni a bankkártyaadataidat vagy lemondani a megújuló előfizetésedet a Stripe biztonságos felületén.</p>
    <form action="/create-portal-session" method="POST">
        <button type="submit" class="button">Ugrás az Ügyfélportálra</button>
    </form>

    <hr>

    <h2>Telegram Összekötés</h2>
    {% if user.chat_id %}
        <div class="alert alert-success">
            <strong>A Telegram fiókod már össze van kötve!</strong><br>
            Mostantól automatikus értesítéseket kapsz a friss tippekről.
        </div>
    {% else %}
        <p>Szeretnél azonnali értesítést kapni a Telegramon? Kösd össze a fiókodat!</p>
        <form action="/generate-telegram-link" method="POST" id="telegram-form">
            <button type="submit" class="button">Összekötés Indítása</button>
        </form>
        <div id="telegram-link-container" style="display:none; margin-top: 15px;">
             <button onclick="closeTelegramLink()" class="button" style="margin-top: 15px;">Bezárás</button>
        </div>
    {% endif %}

<script>
// Ez a script kezeli a Telegram link generálását anélkül, hogy új oldalra vinne
const form = document.getElementById('telegram-form');
const telegramLinkContainer = document.getElementById('telegram-link-container');

if (form) {
    form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const response = await fetch('/generate-telegram-link', {
            method: 'POST'
        });
        
        if (response.ok) {
            const content = await response.text();
            // Ellenőrizzük, hogy a tartalom egy linket tartalmaz-e, vagy csak egy üzenetet
            const parser = new DOMParser();
            const doc = parser.parseFromString(content, 'text/html');
            const linkElement = doc.querySelector('a');

            if (linkElement) {
                // Ha van link, akkor azt és a bezárás gombot jelenítjük meg
                telegramLinkContainer.innerHTML = content + '<button onclick="closeTelegramLink()" class="button" style="margin-top: 15px;">Bezárás</button>';
            } else {
                // Ha nincs link (pl. hibaüzenet), akkor csak azt és a bezárás gombot
                telegramLinkContainer.innerHTML = content + '<button onclick="closeTelegramLink()" class="button" style="margin-top: 15px;">Bezárás</button>';
            }
            telegramLinkContainer.style.display = 'block';
            form.style.display = 'none'; // Elrejtjük a "Összekötés Indítása" gombot
        } else {
            telegramLinkContainer.innerHTML = '<div class="alert alert-danger">Hiba történt a link generálása közben.</div><button onclick="closeTelegramLink()" class="button" style="margin-top: 15px;">Bezárás</button>';
            telegramLinkContainer.style.display = 'block';
            form.style.display = 'none';
        }
    });
}

function closeTelegramLink() {
    telegramLinkContainer.style.display = 'none';
    form.style.display = 'block'; // Visszaállítjuk a "Összekötés Indítása" gombot
    telegramLinkContainer.innerHTML = ''; // Kiürítjük a tartalmát
}
</script>

{% endblock %}
